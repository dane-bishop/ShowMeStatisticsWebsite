{% extends 'base.html' %}
{% from "components/player_card.html" import player_card %}

{% block title %}Profile • ShowMeStatistics{% endblock %}

{% block content %}
<section class="profile">
  <h2>Account</h2>

  <div class="grid two">

    <!-- LEFT CARD -->
    <div class="card long">
      <div class="card-title">Your Account</div>
      <div class="card-meta">Email: {{ user.email }}</div>
      <div class="card-meta">
        Member since: {{ user.created_at.strftime('%b %d, %Y') if user.created_at else '—' }}
      </div>

      <hr>

      <!-- ⭐ NEW AVATAR SECTION (added only this block) -->
      <div class="profile-avatar-wrapper">
        <div class="profile-avatar-label">Profile picture</div>
        <div id="profile-avatar"></div>
        <button type="button" class="avatar-upload-btn" id="avatar-upload-btn">
          Change Photo
        </button>
        <input type="file" id="avatar-file-input" accept="image/*" style="display:none;">
      </div>

      <hr>

      <!-- Display name -->
      <form method="post" action="{{ url_for('routes.profile_update_display_name') }}" class="auth-form">
        <label>Display name
          <input type="text" name="display_name" value="{{ user.display_name or '' }}" placeholder="Your name">
        </label>
        <button type="submit" class="btn">Update Name</button>
      </form>

      <hr>

      <!-- Password change -->
      <form method="post" action="{{ url_for('routes.profile_change_password') }}" class="auth-form">
        <label>Current password
          <input type="password" name="current_password" required>
        </label>
        <label>New password
          <input type="password" name="new_password" required>
        </label>
        <button type="submit" class="btn">Change Password</button>
      </form>

      <hr>

      <form method="post" action="{{ url_for('auth.logout_submit') }}">
        <button type="submit" class="btn btn-secondary">Sign out</button>
      </form>
    </div>

    <!-- RIGHT SIDE (EXACTLY YOUR LIVE SITE) -->
    <div>
      <div class="card">
        <div class="card-title">Saved Players</div>
        {% if fav_players|length == 0 %}
          <p>No saved players yet. Find a player and tap the ♥ icon.</p>
        {% else %}
          <div class="cards three">
            {% for p in fav_players %}
              {{ player_card(p) }}
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="card" style="margin-top: 20px;">
        <div class="card-title">Saved Teams</div>
        <p>No saved teams yet. Find a team and tap the ♥ icon.</p>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const avatar = document.getElementById('profile-avatar');
  const fileInput = document.getElementById('avatar-file-input');
  const uploadBtn = document.getElementById('avatar-upload-btn');

  // Load saved avatar
  const saved = localStorage.getItem('sms_profile_avatar');
  if (saved) {
    avatar.style.backgroundImage = `url(${saved})`;
    avatar.style.backgroundSize = "cover";
    avatar.style.backgroundPosition = "center";
  }

  uploadBtn.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const dataUrl = event.target.result;
      avatar.style.backgroundImage = `url(${dataUrl})`;
      avatar.style.backgroundSize = "cover";
      avatar.style.backgroundPosition = "center";
      localStorage.setItem('sms_profile_avatar', dataUrl);
    };
    reader.readAsDataURL(file);
  });
});
</script>
{% endblock %}
